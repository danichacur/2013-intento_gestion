USE [GD1C2013]
GO

/****** Object:  StoredProcedure [dbo].[microAlterno]    Script Date: 06/20/2013 20:14:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[microAlterno] 
	-- Add the parameters for the stored procedure here
	 @PATENTE VARCHAR(6),
	 @FECHA_INI DATETIME,
	 @FECHA_FIN DATETIME
AS
BEGIN

-- Y SI SON VARIOS LOS VIAJES? PUEDO ITERAR HASTA QUE NO HAYA NINGUNO?
SELECT TOP 1 A.MICR_ID
FROM TRANSPORTADOS.MICROS A,
TRANSPORTADOS.MICROS B,
TRANSPORTADOS.VIAJES V
/*BUSCO UN MICRO DE LAS MISMAS CARACTERISTICAS QUE NO ESTE INHABILITADO*/
WHERE B.MICR_PATENTE = @PATENTE
AND A.MICR_PATENTE <> @PATENTE
AND A.MICR_CANT_BUTACAS = B.MICR_CANT_BUTACAS
AND A.MICR_PISOS = B.MICR_PISOS
AND A.MICR_MARCA = B.MICR_MARCA
AND A.MICR_MODELO = B.MICR_MODELO
AND A.MICR_BAJA = 0
AND A.MICR_BAJA_TECNICA = 0
AND A.MICR_TIPO_ID = B.MICR_TIPO_ID
--/*BUSCO QUE LOS ASIENTOS LIBRES (NO VENDIDOS) ALCANCEN*/
--AND (A.MICR_CANT_BUTACAS -
--	(SELECT SUM(PASA_CANTIDAD) FROM 
--	TRANSPORTADOS.PASAJE Q
--	WHERE Q.PASA_VIAJE_ID = V.VIAJ_ID
--	AND V.VIAJ_MICRO = A.MICR_ID)) 
--	> =
----ESTOS SON LOS PASAJES VENDIDOS DEL MICRO DADO DE BAJA
--(SELECT SUM(PASA_CANTIDAD) FROM TRANSPORTADOS.PASAJE Q
--	WHERE Q.PASA_VIAJE_ID = V.VIAJ_ID
--	AND V.VIAJ_MICRO = B.MICR_ID)
	
/*BUSCO QUE NO TENGA VIAJES ASIGNADOS*/ 
AND NOT EXISTS (SELECT 1 FROM TRANSPORTADOS.VIAJES C
				WHERE V.VIAJ_MICRO = B.MICR_ID
				AND C.VIAJ_MICRO = A.MICR_ID
				--AND C.VIAJ_FECHA_LLEGADA = V.VIAJ_FECHA_LLEGADA
				--AND C.VIAJ_FECHA_SALIDA = V.VIAJ_FECHA_SALIDA
				AND C.VIAJ_RECORRIDO = V.VIAJ_RECORRIDO
				--AND V.VIAJ_FECHA_SALIDA BETWEEN @FECHA_INI AND @FECHA_FIN
				)



   
END

GO


